---
title: 'Spring AOP'
layout: post
categories: spring
---

## 용어 정리

#### Aspect
여러 곳에서 쓰이는 코드(공통 부분)를 모듈화한 것  
Advice + JoinPoint 로 이루어진다.

#### Target
Aspect가 적용되는 곳

#### Advice
Aspect에서 실질적인 기능을 구현한 구현체

#### JoinPoint
Advice가 Target 에 적용되는 시점  
메서드 진입할 때, 생성자 호출할 때, 필드에서 값을 꺼낼 때 등등

#### PointCut 
Joint point 의 상세 스펙을 정의한 것

### Proxy
타겟을 감싸서 타겟의 요청을 대신 받아주는 랩핑 오브젝트이다.
클라이언트가 타겟을 호출하게 되면 프록시가 호출을 가로채 어드바이스에 등록된 기능을 수행 후 타겟 메소드를 호출한다.

## 예제
의존성 추가
```groovy
implementation("org.springframework.boot:spring-boot-starter-aop")
```

#### 기본 예시
```java
@Aspect
@Component
public class Performance {
    
    @Pointcut("execution(* com.board.BoardService.getBoards(..))")
    public void getBoards(){}

    @Pointcut("execution(* com.user.UserService.getUsers(..))")
    public void getUsers(){}

    @Around("getBoards() || getUsers()")
    public Object calculatePerformanceTime(ProceedingJoinPoint proceedingJoinPoint) {
        Object result = null;
        try {
            long start = System.currentTimeMillis();
            result = proceedingJoinPoint.proceed();
            long end = System.currentTimeMillis();

            System.out.println("수행 시간 : "+ (end - start));
        } catch (Throwable throwable) {
            System.out.println("exception! ");
        }
        return result;
    }
}
```

#### Aspect에서 타겟 메서드의 파라미터 사용
```java
@Aspect
@Component
public class UserHistory {

    @Autowired
    private HistoryRepository historyRepository;

    @Pointcut("execution(* com.user.UserService.update(*)) && args(user)")
    public void updateUser(User user){}

    @AfterReturning("updateUser(user)")
    public void saveHistory(User user){
        historyRepository.save(new History(user.getIdx()));
    }
}

```

#### Annotaion 기반으로 Aspect 적용
애노테이션 생성
```java
@Documented
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.CLASS)
public @interface PerfLogging {
}
```

Aspect클래스 포인트컷 변경
```java
@Component
@Aspect
public class PerfAspect {

  @Around("@annotation(PerfLogging)")
  public Object logPerf(ProceedingJoinPoint pjp) throws Throwable {
    long begin = System.currentTimeMillis();
    Object retVal = pjp.proceed();
    System.out.println(System.currentTimeMillis() - begin);
    return retVal;
  }
}
```

Aspect 적용
```java
@Component
public class SimpleServiceEvent {

  @PerfLogging
  @Override
  public void created() {
    ...
  }
}
```


## reference
- <https://jojoldu.tistory.com/71?category=635883>
- <https://dailyheumsi.tistory.com/202>
